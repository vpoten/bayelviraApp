/* FusionDialog.java */

package elvira.gui;

import java.awt.*;
import javax.swing.*;
import java.util.Vector;
import java.util.ResourceBundle;

import elvira.Bnet;
import elvira.IDiagram;
import elvira.fusion.*;

import elvira.Elvira;


/**
 * This dialog content the necessary components for selecting the
 * fusion methods (qualitative and quantitative) and the networks
 * that will be fused
 *
 * @author Roberto Atienza
 */

public class FusionDialog extends javax.swing.JDialog
{
   
   /**
    * Main constructor. Defines the list that will contained the
    * networks that can be fused and the combo boxes to select the
    * qualitative and quantitative methods
    */
    
	public FusionDialog(Frame parent)
	{
		super(parent);
		dialogBundle = Elvira.getElviraFrame().getDialogBundle();		
		
		// This code is automatically generated by Visual Cafe when you add
		// components to the visual environment. It instantiates and initializes
		// the components. To modify the code, only use code syntax that matches
		// what Visual Cafe can generate, or Visual Cafe may be unable to back
		// parse your Java file into its visual environment.
		//{{INIT_CONTROLS
		setResizable(false);
		setModal(true);
		setTitle(localize(dialogBundle,"FusionDialog.Title"));
		getContentPane().setLayout(null);
		setSize(422,337);
		setVisible(false);
		getContentPane().add(fusionList);
		fusionList.setBounds(24,48,384,132);
		chooseLabel.setText(localize(dialogBundle,"FusionDialog.Choose"));
		getContentPane().add(chooseLabel);
		chooseLabel.setBounds(24,12,252,28);
		okButton.setText("Fusion");
		okButton.setActionCommand(localize(dialogBundle,"FusionDialog.Fusion"));
		okButton.setMnemonic((int)'F');
		getContentPane().add(okButton);
		okButton.setBounds(108,288,84,40);
		cancelButton.setText(localize(dialogBundle,"Cancel.label"));
		cancelButton.setActionCommand("Cancel");
		cancelButton.setMnemonic((int)'C');
		getContentPane().add(cancelButton);
		cancelButton.setBounds(216,288,84,40);
		qualitativeLabel.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
		qualitativeLabel.setText(localize(dialogBundle,"FusionDialog.Qualitative"));
		getContentPane().add(qualitativeLabel);
		qualitativeLabel.setBounds(24,204,120,28);
		getContentPane().add(qualitativeComboBox);
		qualitativeComboBox.setBounds(156,204,252,24);
		quantitativeLabel.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
		quantitativeLabel.setText(localize(dialogBundle,"FusionDialog.Quantitative"));
		getContentPane().add(quantitativeLabel);
		quantitativeLabel.setBounds(24,240,120,28);
		getContentPane().add(quantitativeComboBox);
		quantitativeComboBox.setBounds(156,240,252,24);
		//}}
		
		setLocationRelativeTo(Elvira.getElviraFrame());
		
		frames = Elvira.getElviraFrame().getDesktopPane().getAllFrames();
		
		//{{REGISTER_LISTENERS
		SymAction lSymAction = new SymAction();
		okButton.addActionListener(lSymAction);
		cancelButton.addActionListener(lSymAction);
		//}}
				
		qualitativeComboBox.addItem(localize(dialogBundle,"FusionDialog.Linear"));
		qualitativeComboBox.addItem(localize(dialogBundle,"FusionDialog.Log"));
		qualitativeComboBox.addItem(localize(dialogBundle,"FusionDialog.NoisyOR"));
		qualitativeComboBox.addItem(localize(dialogBundle,"FusionDialog.NoisyORLoose"));
		
		quantitativeComboBox.addItem(localize(dialogBundle,"FusionDialog.Union"));
		quantitativeComboBox.addItem(localize(dialogBundle,"FusionDialog.Intersection"));
		quantitativeComboBox.addItem(localize(dialogBundle,"FusionDialog.Extended"));
		quantitativeComboBox.addItem(localize(dialogBundle,"FusionDialog.Maximal"));
			
		if (!getList()) {
		   ShowMessages.showMessageDialog (ShowMessages.NOT_ENOUGH_NETWORKS, 
		                                   JOptionPane.ERROR_MESSAGE);
		   canShow = false;
		}
	}


   /**
    * Create a new dialog without a parent
    */
    
	public FusionDialog()
	{
		this((Frame)null);
	}
	
	
	/**
	 * Create a new FusionDialog without a parent a set its title
	 */

	public FusionDialog(String sTitle)
	{
		this();
		setTitle(sTitle);
	}	

	public void setVisible(boolean b)
	{
		if (b)
			setLocation(50, 50);
		super.setVisible(b);
	}

	static public void main(String args[])
	{
		(new FusionDialog()).setVisible(true);
	}

	public void addNotify()
	{
		// Record the size of the window prior to calling parents addNotify.
		Dimension size = getSize();

		super.addNotify();

		if (frameSizeAdjusted)
			return;
		frameSizeAdjusted = true;

		// Adjust size of frame according to the insets
		Insets insets = getInsets();
		setSize(insets.left + insets.right + size.width, insets.top + insets.bottom + size.height);
	}

	// Used by addNotify
	boolean frameSizeAdjusted = false;

	//{{DECLARE_CONTROLS
	javax.swing.JList fusionList = new javax.swing.JList();
	javax.swing.JLabel chooseLabel = new javax.swing.JLabel();
	javax.swing.JButton okButton = new javax.swing.JButton();
	javax.swing.JButton cancelButton = new javax.swing.JButton();
	javax.swing.JLabel qualitativeLabel = new javax.swing.JLabel();
	javax.swing.JComboBox qualitativeComboBox = new javax.swing.JComboBox();
	javax.swing.JLabel quantitativeLabel = new javax.swing.JLabel();
	javax.swing.JComboBox quantitativeComboBox = new javax.swing.JComboBox();
	//}}
	
	ResourceBundle dialogBundle;
	
	/**
	 * A reference to the frames variable of the ElviraFrame object
	 * It will contained the opened frames in elvira. This variable will
	 * be useful for displaying the list of networks that can be fused
	 */
	 
	JInternalFrame[] frames;
	
	public boolean canShow = true;
	
	public boolean canShow() {
	   return canShow;
	}
	
	
	/**
	 * Construct the list of open networks in elvira that can be fused.
	 * To do list get the name of all the opened frames that are stored
	 * in the frames variable.
	 * The obtained list is stored in the fusionList variable.
	 */
	
	public boolean getList() {	   
	   Vector v = new Vector();
	   Bnet b;
	   for (int i=0; i<frames.length; i++) 
	      if (frames[i].getClass()!=MessageFrame.class) {
	         b = ((NetworkFrame) frames[i]).getEditorPanel().getBayesNet();
	         if (b.getClass()!=IDiagram.class) {
	            v.add(frames[i].getTitle());
	         }
	      }
	   
	   if (v.size()>=2) {	   
	      fusionList.setListData(v);
	      return true;
	   }
	   else
	      return false;
	}



   /**
    * This class handles the actions that are fired in 
    * the FusionDialog
    */
    
	class SymAction implements java.awt.event.ActionListener
	{
		public void actionPerformed(java.awt.event.ActionEvent event)
		{
			Object object = event.getSource();
			if (object == okButton)
				okButton_actionPerformed(event);
			else if (object == cancelButton)
				cancelButton_actionPerformed(event);
		}
	}
	
	
	/**
	 * Fuse the two networks selected in the FusionList
	 */

	void okButton_actionPerformed(java.awt.event.ActionEvent event)
	{
		int[] indexes = fusionList.getSelectedIndices();
		Bnet b1, b2;
		Fusion f;
		
		if (indexes.length!=2) {
         ShowMessages.showMessageDialog (ShowMessages.WRONG_NETWORKS_SELECTED, 
		                                   JOptionPane.ERROR_MESSAGE);
		}
		else {
		   b1 = ((NetworkFrame) frames[indexes[0]]).getEditorPanel().getBayesNet();
		   b2 = ((NetworkFrame) frames[indexes[1]]).getEditorPanel().getBayesNet();
		   if ((b1.getClass()==IDiagram.class) || (b2.getClass()==IDiagram.class))
		      ShowMessages.showMessageDialog (ShowMessages.WRONG_NETWORKS_SELECTED, 
		                                       JOptionPane.ERROR_MESSAGE);
         else {
            int qualType = qualitativeComboBox.getSelectedIndex(), 
                quanType = quantitativeComboBox.getSelectedIndex();
            
		      try {                                   
               f = new Fusion(qualType, quanType, b1, b2);
               Elvira.getElviraFrame().addNewFrame(f.getBnet());
            } catch (Exception e) {}
         }
		}
		
		dispose();
			 
	}

	void cancelButton_actionPerformed(java.awt.event.ActionEvent event)
	{
		dispose();			 
	}
	
	
	/**
	 * Using with the bundles. Find the string given as parameter in
	 * the bundle specified
	 */
	
   public String localize (ResourceBundle bundle, String name) {
      return Elvira.getElviraFrame().localize(bundle, name);
   }	
	
	
} // end FusionDialog class